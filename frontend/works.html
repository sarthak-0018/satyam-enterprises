<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Recent Works - Satyam Enterprises</title>
  <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
  <div class="admin-page-header">
    <h1>üõ†Ô∏è Manage Recent Works</h1>
    <div class="header-actions">
      <a href="admin-panel.html">‚Üê Back to Panel</a>
    </div>
  </div>

  <div class="admin-container">
    <div class="admin-card">
      <h2>Add New Work</h2>
      <form id="workForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="title">Work Title *</label>
          <input type="text" id="title" name="title" placeholder="Enter work title" required>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" placeholder="Describe the work completed"></textarea>
        </div>

        <div class="form-group">
          <label>Work Images * (Multiple images allowed)</label>
          <div class="file-input-wrapper">
            <input type="file" name="images" multiple accept="image/*" required>
            <div class="file-preview" id="filePreview"></div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Add Work</button>
      </form>

      <div id="msg" class="alert"></div>
    </div>

    <div class="admin-card">
      <h2>Existing Works</h2>
      <div id="list">
        <div class="empty-state">
          <p>Loading works...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.querySelector('input[name="images"]');
    const filePreview = document.getElementById('filePreview');
    const selectedFiles = [];

    fileInput.addEventListener('change', function(e) {
      filePreview.innerHTML = '';
      selectedFiles.length = 0;
      
      Array.from(e.target.files).forEach((file, index) => {
        selectedFiles.push(file);
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewItem = document.createElement('div');
          previewItem.className = 'file-preview-item';
          previewItem.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove" onclick="removeFile(${index})">√ó</button>
          `;
          filePreview.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
      });
    });

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateFileInput();
      updatePreview();
    }

    function updateFileInput() {
      const dt = new DataTransfer();
      selectedFiles.forEach(file => dt.items.add(file));
      fileInput.files = dt.files;
    }

    function updatePreview() {
      filePreview.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewItem = document.createElement('div');
          previewItem.className = 'file-preview-item';
          previewItem.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove" onclick="removeFile(${index})">√ó</button>
          `;
          filePreview.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
      });
    }

    function showMessage(text, type) {
      const msg = document.getElementById("msg");
      msg.textContent = text;
      msg.className = `alert alert-${type} show`;
      setTimeout(() => {
        msg.classList.remove('show');
      }, 3000);
    }

    document.getElementById("workForm").addEventListener("submit", function(e){
      e.preventDefault();
      const formData = new FormData(this);

      fetch("/admin/add-work", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(() => {
        showMessage("Work added successfully!", "success");
        this.reset();
        filePreview.innerHTML = '';
        selectedFiles.length = 0;
        loadWorks();
      })
      .catch(err => {
        showMessage("Error adding work. Please try again.", "error");
        console.error(err);
      });
    });

    function loadWorks(){
      fetch("/admin/works")
        .then(res => res.json())
        .then(data => {
          if(data.length === 0){
            document.getElementById("list").innerHTML = `
              <div class="empty-state">
                <p>No works added yet</p>
                <p style="font-size: 14px;">Add your first work using the form above</p>
              </div>
            `;
            return;
          }

          let activeHTML = "<h3 style='color: #28a745; margin-bottom: 20px;'>Active Works</h3><div class='products-grid'>";
          let deletedHTML = "<h3 style='color: #dc3545; margin-top: 40px; margin-bottom: 20px;'>Deleted Works</h3><div class='products-grid'>";

          let hasActive = false;
          let hasDeleted = false;

          data.forEach(w => {
            const images = w.images && w.images.length > 0 ? w.images : (w.image ? [w.image] : []);
            const imagesHTML = images.map(img => 
              `<img src="/${img}" alt="Work image">`
            ).join('');

            if(w.status === "active"){
              hasActive = true;
              activeHTML += `
                <div class="product-item active">
                  <div class="product-images">
                    ${imagesHTML}
                  </div>
                  <div class="product-info">
                    <b>${w.title}</b>
                    ${w.description ? `<span>${w.description}</span>` : ''}
                  </div>
                  <div class="product-actions">
                    <button class="btn btn-danger btn-sm" onclick="del(${w.id})">Delete</button>
                  </div>
                </div>
              `;
            }

            if(w.status === "hidden"){
              hasDeleted = true;
              deletedHTML += `
                <div class="product-item hidden">
                  <div class="product-images">
                    ${imagesHTML}
                  </div>
                  <div class="product-info">
                    <b>${w.title}</b>
                    ${w.description ? `<span>${w.description}</span>` : ''}
                  </div>
                  <div class="product-actions">
                    <button class="btn btn-success btn-sm" onclick="restore(${w.id})">Restore</button>
                  </div>
                </div>
              `;
            }
          });

          activeHTML += "</div>";
          deletedHTML += "</div>";

          let finalHTML = '';
          if (hasActive) finalHTML += activeHTML;
          if (hasActive && hasDeleted) finalHTML += "<hr style='margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;'>";
          if (hasDeleted) finalHTML += deletedHTML;
          
          document.getElementById("list").innerHTML = finalHTML || `
            <div class="empty-state">
              <p>No works added yet</p>
            </div>
          `;
        })
        .catch(err => {
          document.getElementById("list").innerHTML = `
            <div class="empty-state">
              <p>Error loading works</p>
              <p style="font-size: 14px;">Please refresh the page</p>
            </div>
          `;
          console.error(err);
        });
    }

    function del(id){
      if (confirm("Are you sure you want to delete this work?")) {
        fetch("/admin/delete-work/" + id, { method: "DELETE" })
          .then(() => {
            showMessage("Work deleted successfully", "success");
            loadWorks();
          });
      }
    }

    function restore(id){
      fetch("/admin/restore-work/" + id, { method: "PUT" })
        .then(() => {
          showMessage("Work restored successfully", "success");
          loadWorks();
        });
    }

    loadWorks();
  </script>
</body>
</html>
