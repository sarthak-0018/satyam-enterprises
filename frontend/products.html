<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Products - Satyam Enterprises</title>
  <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
  <div class="admin-page-header">
    <h1>üì¶ Manage Products</h1>
    <div class="header-actions">
      <a href="admin-panel.html">‚Üê Back to Panel</a>
    </div>
  </div>

  <div class="admin-container">
    <div class="admin-card">
      <h2>Add New Product</h2>
      <form id="productForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="name">Product Name *</label>
          <input type="text" id="name" name="name" placeholder="Enter product name" required>
        </div>

        <div class="form-group">
          <label for="category">Category</label>
          <input type="text" id="category" name="category" placeholder="e.g., CCTV, Printer, Hardware">
        </div>

        <div class="form-group">
          <label for="price">Price</label>
          <input type="text" id="price" name="price" placeholder="e.g., ‚Çπ5,000 or Contact for price">
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" placeholder="Enter product description"></textarea>
        </div>

        <div class="form-group">
          <label>Product Images * (Multiple images allowed)</label>
          <div class="file-input-wrapper">
            <input type="file" name="images" multiple accept="image/*" required>
            <div class="file-preview" id="filePreview"></div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Add Product</button>
      </form>

      <div id="msg" class="alert"></div>
    </div>

    <div class="admin-card">
      <h2>Existing Products</h2>
      <div id="list">
        <div class="empty-state">
          <p>Loading products...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.querySelector('input[name="images"]');
    const filePreview = document.getElementById('filePreview');
    const selectedFiles = [];

    fileInput.addEventListener('change', function(e) {
      filePreview.innerHTML = '';
      selectedFiles.length = 0;
      
      Array.from(e.target.files).forEach((file, index) => {
        selectedFiles.push(file);
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewItem = document.createElement('div');
          previewItem.className = 'file-preview-item';
          previewItem.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove" onclick="removeFile(${index})">√ó</button>
          `;
          filePreview.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
      });
    });

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateFileInput();
      updatePreview();
    }

    function updateFileInput() {
      const dt = new DataTransfer();
      selectedFiles.forEach(file => dt.items.add(file));
      fileInput.files = dt.files;
    }

    function updatePreview() {
      filePreview.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewItem = document.createElement('div');
          previewItem.className = 'file-preview-item';
          previewItem.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove" onclick="removeFile(${index})">√ó</button>
          `;
          filePreview.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
      });
    }

    function showMessage(text, type) {
      const msg = document.getElementById("msg");
      msg.textContent = text;
      msg.className = `alert alert-${type} show`;
      setTimeout(() => {
        msg.classList.remove('show');
      }, 3000);
    }

    document.getElementById("productForm").onsubmit = function(e){
      e.preventDefault();
      let formData = new FormData(this);

      fetch("/admin/add-product", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(() => {
        showMessage("Product added successfully!", "success");
        this.reset();
        filePreview.innerHTML = '';
        selectedFiles.length = 0;
        loadProducts();
      })
      .catch(err => {
        showMessage("Error adding product. Please try again.", "error");
        console.error(err);
      });
    };

    function loadProducts(){
      fetch("/admin/products")
        .then(res => res.json())
        .then(data => {
          if(data.length === 0){
            document.getElementById("list").innerHTML = `
              <div class="empty-state">
                <p>No products found</p>
                <p style="font-size: 14px;">Add your first product using the form above</p>
              </div>
            `;
            return;
          }

          let activeHTML = "<h3 style='color: #28a745; margin-bottom: 20px;'>Active Products</h3><div class='products-grid'>";
          let deletedHTML = "<h3 style='color: #dc3545; margin-top: 40px; margin-bottom: 20px;'>Deleted Products</h3><div class='products-grid'>";

          let hasActive = false;
          let hasDeleted = false;

          data.forEach(p => {
            const images = p.images && p.images.length > 0 ? p.images : (p.image ? [p.image] : []);
            const imagesHTML = images.map(img => 
              `<img src="/${img}" alt="Product image">`
            ).join('');

            if(p.status === "active"){
              hasActive = true;
              activeHTML += `
                <div class="product-item active">
                  <div class="product-images">
                    ${imagesHTML}
                  </div>
                  <div class="product-info">
                    <b>${p.name}</b>
                    ${p.price ? `<span>Price: ${p.price}</span>` : ''}
                    ${p.category ? `<span>Category: ${p.category}</span>` : ''}
                  </div>
                  <div class="product-actions">
                    <button class="btn btn-danger btn-sm" onclick="del(${p.id})">Delete</button>
                  </div>
                </div>
              `;
            }

            if(p.status === "hidden"){
              hasDeleted = true;
              deletedHTML += `
                <div class="product-item hidden">
                  <div class="product-images">
                    ${imagesHTML}
                  </div>
                  <div class="product-info">
                    <b>${p.name}</b>
                    ${p.price ? `<span>Price: ${p.price}</span>` : ''}
                    ${p.category ? `<span>Category: ${p.category}</span>` : ''}
                  </div>
                  <div class="product-actions">
                    <button class="btn btn-success btn-sm" onclick="restore(${p.id})">Restore</button>
                  </div>
                </div>
              `;
            }
          });

          activeHTML += "</div>";
          deletedHTML += "</div>";

          let finalHTML = '';
          if (hasActive) finalHTML += activeHTML;
          if (hasActive && hasDeleted) finalHTML += "<hr style='margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;'>";
          if (hasDeleted) finalHTML += deletedHTML;
          
          document.getElementById("list").innerHTML = finalHTML || `
            <div class="empty-state">
              <p>No products found</p>
            </div>
          `;
        })
        .catch(err => {
          document.getElementById("list").innerHTML = `
            <div class="empty-state">
              <p>Error loading products</p>
              <p style="font-size: 14px;">Please refresh the page</p>
            </div>
          `;
          console.error(err);
        });
    }

    function del(id){
      if (confirm("Are you sure you want to delete this product?")) {
        fetch("/admin/delete-product/" + id, { method: "DELETE" })
          .then(() => {
            showMessage("Product deleted successfully", "success");
            loadProducts();
          });
      }
    }

    function restore(id){
      fetch("/admin/restore-product/" + id, { method: "PUT" })
        .then(() => {
          showMessage("Product restored successfully", "success");
          loadProducts();
        });
    }

    loadProducts();
  </script>
</body>
</html>
