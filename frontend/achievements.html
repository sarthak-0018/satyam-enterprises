<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Achievements - Satyam Enterprises</title>
  <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
  <div class="admin-page-header">
    <h1>üèÜ Manage Achievements</h1>
    <div class="header-actions">
      <a href="admin-panel.html">‚Üê Back to Panel</a>
    </div>
  </div>

  <div class="admin-container">
    <div class="admin-card">
      <h2>Add New Achievement</h2>
      <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
        Add certificates, awards, client testimonials, or any achievements you want to showcase.
      </p>
      <form id="achForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="title">Achievement Title *</label>
          <input type="text" id="title" name="title" placeholder="e.g., Certificate of Excellence, Client Award" required>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" placeholder="Describe the achievement or award"></textarea>
        </div>

        <div class="form-group">
          <label>Achievement Images * (Multiple images allowed)</label>
          <div class="file-input-wrapper">
            <input type="file" name="images" multiple accept="image/*" required>
            <div class="file-preview" id="filePreview"></div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Add Achievement</button>
      </form>

      <div id="msg" class="alert"></div>
    </div>

    <div class="admin-card">
      <h2>Existing Achievements</h2>
      <div id="list">
        <div class="empty-state">
          <p>Loading achievements...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.querySelector('input[name="images"]');
    const filePreview = document.getElementById('filePreview');
    const selectedFiles = [];

    fileInput.addEventListener('change', function(e) {
      filePreview.innerHTML = '';
      selectedFiles.length = 0;
      
      Array.from(e.target.files).forEach((file, index) => {
        selectedFiles.push(file);
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewItem = document.createElement('div');
          previewItem.className = 'file-preview-item';
          previewItem.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove" onclick="removeFile(${index})">√ó</button>
          `;
          filePreview.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
      });
    });

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateFileInput();
      updatePreview();
    }

    function updateFileInput() {
      const dt = new DataTransfer();
      selectedFiles.forEach(file => dt.items.add(file));
      fileInput.files = dt.files;
    }

    function updatePreview() {
      filePreview.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewItem = document.createElement('div');
          previewItem.className = 'file-preview-item';
          previewItem.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove" onclick="removeFile(${index})">√ó</button>
          `;
          filePreview.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
      });
    }

    function showMessage(text, type) {
      const msg = document.getElementById("msg");
      msg.textContent = text;
      msg.className = `alert alert-${type} show`;
      setTimeout(() => {
        msg.classList.remove('show');
      }, 3000);
    }

    document.getElementById("achForm").onsubmit = function(e){
      e.preventDefault();
      let fd = new FormData(this);

      fetch("/admin/add-achievement", {
        method: "POST",
        body: fd
      })
      .then(res => res.json())
      .then(() => {
        showMessage("Achievement added successfully!", "success");
        this.reset();
        filePreview.innerHTML = '';
        selectedFiles.length = 0;
        loadAchievements();
      })
      .catch(err => {
        showMessage("Error adding achievement. Please try again.", "error");
        console.error(err);
      });
    };

    function loadAchievements(){
      fetch("/admin/achievements")
        .then(r => r.json())
        .then(data => {
          if(data.length === 0){
            document.getElementById("list").innerHTML = `
              <div class="empty-state">
                <p>No achievements yet</p>
                <p style="font-size: 14px;">Add your first achievement using the form above</p>
              </div>
            `;
            return;
          }

          let activeHTML = "<h3 style='color: #28a745; margin-bottom: 20px;'>Active Achievements</h3><div class='products-grid'>";
          let deletedHTML = "<h3 style='color: #dc3545; margin-top: 40px; margin-bottom: 20px;'>Deleted Achievements</h3><div class='products-grid'>";

          let hasActive = false;
          let hasDeleted = false;

          data.forEach(a => {
            const images = a.images && a.images.length > 0 ? a.images : (a.image ? [a.image] : []);
            const imagesHTML = images.map(img => 
              `<img src="/${img}" alt="Achievement image">`
            ).join('');

            if(a.status === "active"){
              hasActive = true;
              activeHTML += `
                <div class="product-item active">
                  <div class="product-images">
                    ${imagesHTML}
                  </div>
                  <div class="product-info">
                    <b>${a.title}</b>
                    ${a.description ? `<span>${a.description}</span>` : ''}
                  </div>
                  <div class="product-actions">
                    <button class="btn btn-danger btn-sm" onclick="del(${a.id})">Delete</button>
                  </div>
                </div>
              `;
            }

            if(a.status === "hidden"){
              hasDeleted = true;
              deletedHTML += `
                <div class="product-item hidden">
                  <div class="product-images">
                    ${imagesHTML}
                  </div>
                  <div class="product-info">
                    <b>${a.title}</b>
                    ${a.description ? `<span>${a.description}</span>` : ''}
                  </div>
                  <div class="product-actions">
                    <button class="btn btn-success btn-sm" onclick="restore(${a.id})">Restore</button>
                  </div>
                </div>
              `;
            }
          });

          activeHTML += "</div>";
          deletedHTML += "</div>";

          let finalHTML = '';
          if (hasActive) finalHTML += activeHTML;
          if (hasActive && hasDeleted) finalHTML += "<hr style='margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;'>";
          if (hasDeleted) finalHTML += deletedHTML;
          
          document.getElementById("list").innerHTML = finalHTML || `
            <div class="empty-state">
              <p>No achievements yet</p>
            </div>
          `;
        })
        .catch(err => {
          document.getElementById("list").innerHTML = `
            <div class="empty-state">
              <p>Error loading achievements</p>
              <p style="font-size: 14px;">Please refresh the page</p>
            </div>
          `;
          console.error(err);
        });
    }

    function del(id){
      if (confirm("Are you sure you want to delete this achievement?")) {
        fetch("/admin/delete-achievement/" + id, { method: "DELETE" })
          .then(() => {
            showMessage("Achievement deleted successfully", "success");
            loadAchievements();
          });
      }
    }

    function restore(id){
      fetch("/admin/restore-achievement/" + id, { method: "PUT" })
        .then(() => {
          showMessage("Achievement restored successfully", "success");
          loadAchievements();
        });
    }

    loadAchievements();
  </script>
</body>
</html>
